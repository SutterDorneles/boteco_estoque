{% extends "admin/base_site.html" %}
{% load i18n %}

{% block content %}
<div style="padding: 20px;">
    <h1>{{ title }}</h1>
    <form method="POST" action="{% url 'admin:gerar_reposicao' %}?unidade_id={{ unidade.id }}">
        {% csrf_token %}
        <input type="hidden" name="unidade_id" value="{{ unidade.id }}">

        <h2 style="margin-top: 20px;">Itens Sugeridos (Estoque Baixo)</h2>
        {% if sugestoes %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Produto</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Estoque Atual</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Estoque Mínimo</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Quantidade a Pedir</th>
                </tr>
            </thead>
            <tbody>
            {% for item in sugestoes %}
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ item.produto_nome }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ item.estoque_atual }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">{{ item.estoque_minimo }}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;"><input type="number" step="0.1" name="produto_{{ item.produto_id }}" value="{{ item.quantidade_sugerida }}" style="width: 80px;"></td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Nenhum item com estoque baixo encontrado para esta unidade.</p>
        {% endif %}
        
        <hr style="margin: 30px 0;">

        <h2>Adicionar Itens Extras (Antecipar Pedido)</h2>
        <p>Selecione um produto e defina a quantidade e a justificativa (opcional).</p>
        
        <div id="itens-extras-container">
            </div>
        <button type="button" id="add-item-extra-btn" style="margin-top: 10px;">+ Adicionar Item</button>

        <br><br>
        <div style="margin-top: 20px;">
            <input type="submit" value="Criar Pedido de Reposição">
        </div>
    </form>
</div>

{{ todos_insumos|json_script:"insumos-data" }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const insumosData = JSON.parse(document.getElementById('insumos-data').textContent);

    document.getElementById('add-item-extra-btn').addEventListener('click', function() {
        const container = document.getElementById('itens-extras-container');
        const newItem = document.createElement('div');
        newItem.style.marginBottom = '10px';
        
        // Dropdown de produtos
        const select = document.createElement('select');
        let options = '<option value="">-- Selecione um produto --</option>';
        insumosData.forEach(function(insumo) {
            options += `<option value="${insumo.id}">${insumo.nome}</option>`;
        });
        select.innerHTML = options;
        
        // Campo de quantidade
        const inputQty = document.createElement('input');
        inputQty.type = 'number';
        inputQty.step = '0.1';
        inputQty.placeholder = 'Quantidade';
        inputQty.style.marginLeft = '10px';
        
        // Campo de justificativa
        const inputJust = document.createElement('input');
        inputJust.type = 'text';
        inputJust.placeholder = 'Justificativa (Ex: Evento)';
        inputJust.style.marginLeft = '10px';
        inputJust.style.width = '200px';
        
        // Lógica para nomear os inputs corretamente
        select.addEventListener('change', function() {
            if (this.value) {
                inputQty.name = `produto_${this.value}`;
                inputJust.name = `justificativa_${this.value}`;
            } else {
                inputQty.name = '';
                inputJust.name = '';
            }
        });

        newItem.appendChild(select);
        newItem.appendChild(inputQty);
        newItem.appendChild(inputJust);
        container.appendChild(newItem);
    });
});
</script>
{% endblock %}